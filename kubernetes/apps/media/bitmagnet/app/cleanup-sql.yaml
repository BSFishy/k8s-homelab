---
# yaml-language-server: $schema=https://github.com/yannh/kubernetes-json-schema/raw/refs/heads/master/v1.33.3/configmap.json
apiVersion: v1
kind: ConfigMap
metadata:
  name: bitmagnet-cleanup-sql
data:
  cleanup.sql: |-
    DO $$
    DECLARE
      candidates bytea[];
    BEGIN
      LOOP
        SELECT array_agg(info_hash) INTO candidates
        FROM (
          SELECT t.info_hash
          FROM torrents t
          WHERE t.updated_at < now() - interval '7 days'
            AND NOT EXISTS (
              SELECT 1
              FROM torrent_contents c
              WHERE c.info_hash = t.info_hash
                AND COALESCE(c.seeders, 0) + COALESCE(c.leechers, 0) > 0
                AND c.updated_at >= now() - interval '7 days'
            )
          ORDER BY t.info_hash
          LIMIT 10
          FOR UPDATE SKIP LOCKED
        ) s;

        EXIT WHEN candidates IS NULL;

        DELETE FROM torrents_torrent_sources WHERE info_hash = ANY (candidates);
        DELETE FROM torrent_contents WHERE info_hash = ANY (candidates);
        DELETE FROM torrent_files WHERE info_hash = ANY (candidates);
        DELETE FROM torrent_hints WHERE info_hash = ANY (candidates);
        DELETE FROM torrent_pieces WHERE info_hash = ANY (candidates);
        DELETE FROM torrent_tags WHERE info_hash = ANY (candidates);
        DELETE FROM torrents WHERE info_hash = ANY (candidates);
      END LOOP;
    END $$;
